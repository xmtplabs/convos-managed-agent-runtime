# Security

Security considerations for deploying convos-agents on Railway with OpenClaw.

## Gateway auth model

OpenClaw's gateway authenticates Control UI connections in two layers:

1. **Token/password auth** — a shared secret (`OPENCLAW_GATEWAY_TOKEN`) proves the client is authorized
2. **Device identity** — a cryptographic pairing handshake registers the client as a trusted device

With device auth enabled (the default since OpenClaw 2026.2.21), the token alone is not enough. The client must also complete device pairing, which:
- Lets you revoke individual devices without rotating the token
- Provides a per-device audit trail
- Means a leaked token can't be used without completing pairing

## Railway deployment

On Railway, the gateway runs behind a reverse proxy. This affects auth in two ways:

### Proxy trust (`trustedProxies`)

Railway terminates TLS and proxies requests to the container. The gateway sees connections from `::1` (IPv6 loopback) with `X-Forwarded-For` headers. Without `trustedProxies`, OpenClaw 2026.2.21 logs:

```
Proxy headers detected from untrusted address. Connection will not be treated as local.
Configure gateway.trustedProxies to restore local client detection behind your proxy.
```

Fix in `openclaw.json`:

```json
{
  "gateway": {
    "trustedProxies": ["::1", "127.0.0.1"]
  }
}
```

This tells the gateway to trust proxy headers from loopback addresses (Railway's internal proxy).

### Device pairing (`dangerouslyDisableDeviceAuth`)

Device pairing requires a cryptographic handshake between the browser and the gateway. On Railway, this handshake can't complete through the reverse proxy — the client connects over the internet and there's no interactive approval mechanism.

Fix in `openclaw.json`:

```json
{
  "gateway": {
    "controlUi": {
      "allowInsecureAuth": true,
      "dangerouslyDisableDeviceAuth": true
    }
  }
}
```

**What you give up with `dangerouslyDisableDeviceAuth: true`:**

| With device auth (default) | Without device auth (Railway) |
|---|---|
| Token + device pairing required | Token is the only auth layer |
| Can revoke individual devices | Must rotate token to revoke anyone |
| Per-device audit trail | No device-level audit |
| Leaked token alone can't connect | Leaked token = full Control UI access |

This is an acceptable tradeoff for headless Railway deployments where the token is stored as a Railway environment variable and not exposed to users.

## OpenClaw 2026.2.21 breaking change

In OpenClaw 2026.2.15, `gateway.controlUi.allowInsecureAuth: true` was sufficient to skip device pairing. In 2026.2.21, this was hardened:

> Gateway/Security: require secure context and paired-device checks for Control UI auth even when `gateway.controlUi.allowInsecureAuth` is set (#20684)

Now `allowInsecureAuth` only controls whether HTTP (non-HTTPS) connections are allowed without device identity. It no longer bypasses device pairing. For that, `dangerouslyDisableDeviceAuth` is required.

## Secrets management

| Secret | Where it lives | Notes |
|--------|---------------|-------|
| `OPENCLAW_GATEWAY_TOKEN` | Railway env var / `.env` | 64-char hex. Controls Control UI + WebSocket access. Generated by `keys.sh` if not set. |
| `SETUP_PASSWORD` | Railway env var / `.env` | Used by the convos extension for setup/provision API auth. Generated by `keys.sh` if not set. |
| `PRIVATE_WALLET_KEY` | Railway env var / `.env` | Ethereum private key for Bankr wallet. Has nothing to do with Convos. Generated by `keys.sh` if not set. |
| `OPENROUTER_API_KEY` | Railway env var / `.env` | Per-instance OpenRouter key. Created via management API or set manually. |
| `AGENTMAIL_API_KEY` | Railway env var / `.env` | AgentMail API key for inbox management. |
| `POOL_API_KEY` | Pool manager env only | Shared secret for pool manager API auth. Not on agent instances. |

**Never commit `.env` files.** The `.gitignore` already excludes them.

**Token rotation:** If `OPENCLAW_GATEWAY_TOKEN` is compromised, set a new value in Railway env vars and redeploy. Since `dangerouslyDisableDeviceAuth` is on, the token is the sole auth boundary — treat it like a password.

## Pool-managed instances

Pool-managed instances have an additional auth layer: the pool-server proxy.

- External traffic hits `pool-server.js` on port 8080
- Pool API endpoints (`/pool/health`, `/pool/provision`, `/pool/restart-gateway`) are gated by `POOL_API_KEY`
- The gateway runs on internal port 18789 (loopback only, not directly accessible)
- pool-server proxies all other HTTP + WebSocket traffic to the gateway

The gateway token (`OPENCLAW_GATEWAY_TOKEN`) is generated per-instance during warmup and returned in the claim response. Each instance has its own token.

## Browser security

The browser tool runs headless Chromium inside the container. Security considerations:

- `noSandbox: true` is required in Docker (no seccomp/namespace support). This means Chrome runs without its usual sandbox — the container itself is the security boundary.
- The browser profile is stored at `$STATE_DIR/browser/openclaw/user-data/`. It persists across gateway restarts (on Railway volume) but is isolated per instance.
- `browser.sh` cleans stale profile locks on startup to prevent a dead Chrome from blocking new instances.
- OpenClaw blocks `file:`, `data:`, and `javascript:` navigation protocols to prevent local file reads via browser tool navigation.

## Checklist

For a new Railway deployment:

- [ ] `OPENCLAW_GATEWAY_TOKEN` set (or let `keys.sh` generate one)
- [ ] `gateway.trustedProxies: ["::1", "127.0.0.1"]` in openclaw.json
- [ ] `gateway.controlUi.dangerouslyDisableDeviceAuth: true` in openclaw.json
- [ ] `gateway.controlUi.allowInsecureAuth: true` in openclaw.json
- [ ] `.env` is in `.gitignore` (already is by default)
- [ ] Railway env vars set for all secrets (not hardcoded in config)
- [ ] Volume mounted for persistent state (`RAILWAY_VOLUME_MOUNT_PATH`)
